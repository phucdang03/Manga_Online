@using Newtonsoft.Json
@using Service.MangaOnline.Commons
@using Service.MangaOnline.ResponseModels

@{
    Layout = "_Layout";
	ViewData["title"] = "truyen";
	var manga = (MangaResponse)ViewData["manga"]!;
}

<link rel="stylesheet" href="~/css/DetailManga.css">

<!-- details -->
<section class="section details">
	<!-- details background -->
	<div class="details__bg" data-bg="/lib/img/home/home__bg.jpg"></div>
	<!-- end details background -->

	<!-- details content -->
	<div class="container">
		<div class="row">
			<!-- title -->
			<div class="col-12">
				<h1 class="details__title">@manga.Name</h1>
			</div>
			<!-- end title -->

			<!-- content -->
			<div class="col-10">
				<div class="card card--details card--series">
					<div class="row">
						<!-- card cover -->
						<div class="col-12 col-sm-4 col-md-4 col-lg-3 col-xl-3">
							<div class="card__cover">
								<img src="/image/manga-image/@manga.Image" alt="@manga.Name"/>
							</div>
						</div>
						<!-- end card cover -->

						<!-- card content -->
						<div class="col-12 col-sm-8 col-md-8 col-lg-9 col-xl-9">
							<div class="card__content">
								<div class="card__wrap">
									<span class="card__rate"><i class="icon ion-ios-star"></i>@manga.Star</span>
								</div>

								<ul class="card__meta">
									<li><span><i class="fa fa-user"></i> Tác giả: </span>@manga.AuthorName</li>
									<li>
										<span><i class="fa fa-rss"></i> Tình trạng: </span>
										@{
											var statusString = manga.Status switch
											{
												0 => "Hoàn thành",
												1 => "Đang cập nhật",
												2 => "Dừng cập nhật",
												_ => ""
											};
										}
										@statusString
									</li>
									<li>
										<span><i class="fa fa-tags"></i> Thể loại:</span>
										@{
											var categories = manga.CategoryMangas;
											foreach (var category in categories!)
											{
												<a asp-page="/Public/CategoriesList" asp-route-cateName="@category.Name">@category.Name</a>
											}
										}
									</li>
									<li><span><i class="fa fa-eye"></i> Lượt xem: </span>@manga.ViewCount</li>
								</ul>

								<div class="card__description card__description--details">
									@manga.Description
								</div>
							</div>
						</div>
						<!-- end card content -->
					</div>
					<div>
                    	<ul class="ratings" style="{margin-top: 5px}">
                          <li class="star" id="star-5" onclick="handleRate(5)"></li>
                          <li class="star" id="star-4" onclick="handleRate(4)"></li>
                          <li class="star" id="star-3" onclick="handleRate(3)"></li>
                          <li class="star" id="star-2" onclick="handleRate(2)"></li>
                          <li class="star" id="star-1" onclick="handleRate(1)"></li>
                        </ul>
                    </div>
					<div class="follow">
							<div id="not-follow">
								<input id="mangaId" value="@manga.Id" hidden/>
								<button onclick="follow()" class="button-follow">
									<i class="fa fa-heart"></i>
									<span>Theo dõi</span>
								</button>
								<span><b>@manga.FollowCount</b> Lượt theo dõi</span>
							</div>

						 <div  id="da-follow" style="display: none"> 
							<button onclick="unFollow()" class="button-unfollow"> 
						 			<i class="fa fa-times"></i>
									<span>Bỏ theo dõi</span>
						 	</button>
						 	<span><b>@manga.FollowCount</b> Lượt theo dõi</span>
						 </div> 
						<a id="add-chapter" style="display: none" href="/Manager/ViewAddChapter?id=@manga.Id" class="link-button">Thêm chapter</a>
					</div>
					
				</div>
			</div>
			<!-- end content -->
			
			<!-- accordion -->
            <div class="col-12 col-xl-6">
            	<div class="card-body">
            		<table class="accordion__list">
            			<thead>
            				<tr>
            					<th>Số chương</th>
            					<th>Tên</th>
            					<th>Cập nhật</th>
            					<th id="admin-actions-header" style="display: none">Thao tác</th>
            				</tr>
            			</thead>
			            <tbody>
			            @if (manga.Chapteres!=null)
			            {
				            foreach (var chapter in manga.Chapteres)
				            {
					            <tr id="chapter-row-@chapter.Id">
						            <th>@chapter.ChapterNumber</th>
						            @if (chapter.Status==(int)ChapterEnum.Normal)
						            {
							            <td>
								            <a href="/Public/detailChapter?id=@chapter.Id" class="chapter_name">@chapter.Name</a>
							            </td>
						            }
						            else
						            {
							            <td style="display: flex" class="disabled">
								            <a href="/Public/detailChapter?id=@chapter.Id" class="chapter_name">@chapter.Name</a>
								            <p style="
                                                color: yellow;
                                                margin: 0px;
                                            ">Vip</p>
								            <div class="td-vip" style="background: black;width: 19%; position: absolute;
                                               height: 21px;opacity: 0.3;"></div>
							            </td>
						            }
						            <td>@chapter.CreatedAt.ToString("dd/MM/yy")</td>
						            <td class="admin-actions-cell" style="display: none">
							            <button class="btn-delete-chapter" 
							                    data-chapter-id="@chapter.Id" 
							                    data-chapter-number="@chapter.ChapterNumber"
							                    data-chapter-name="@chapter.Name"
							                    data-manga-id="@manga.Id"
							                    style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 12px;"
							                    title="Xóa chapter @chapter.ChapterNumber">
								            🗑️ Xóa
							            </button>
						            </td>
					            </tr>
				            }
			            }
			            }
			            </tbody>
            		</table>
            	</div>
            </div>
            <!-- end accordion -->
		</div>
	</div>
	<!-- end details content -->
</section>
<!-- end details -->

<!-- content -->
<section class="content">
	<div class="content__head">
		<div class="container">
			<div class="row">
				<div class="col-12">
					<!-- content title -->
					<h2 class="content__title">Diễn đàn</h2>
					<!-- end content title -->

					<!-- content tabs nav -->
					<ul class="nav nav-tabs content__tabs" id="content__tabs" role="tablist">
						<li class="nav-item">
							<a class="nav-link active" data-toggle="tab" href="#tab-1" role="tab" aria-controls="tab-1" aria-selected="true">Bình luận</a>
						</li>
					</ul>
					<!-- end content tabs nav -->

					<!-- content mobile tabs nav -->
					<div class="content__mobile-tabs" id="content__mobile-tabs">
						<div class="content__mobile-tabs-btn dropdown-toggle" role="navigation" id="mobile-tabs" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
							<input type="button" value="Bình Luận">
							<span></span>
						</div>

						<div class="content__mobile-tabs-menu dropdown-menu" aria-labelledby="mobile-tabs">
							<ul class="nav nav-tabs" role="tablist">
								<li class="nav-item"><a class="nav-link active" id="1-tab" data-toggle="tab" href="#tab-1" role="tab" aria-controls="tab-1" aria-selected="true">Bình luận</a></li>
							</ul>
						</div>
					</div>
					<!-- end content mobile tabs nav -->
				</div>
			</div>
		</div>
	</div>

	<div class="container">
		<div class="row">
			<div class="col-12 col-lg-8 col-xl-8">
				<!-- content tabs -->
				<div class="tab-content" id="myTabContent">
					<div class="tab-pane fade show active" id="tab-1" role="tabpanel" aria-labelledby="1-tab">
						<div class="row">
							<!-- comments -->
							<div class="col-12">
								<div class="comments">
									<ul class="comments__list">
										
									</ul>

									<div class="form">
										<textarea id="value-cmt" class="form__textarea" placeholder="Viết bình luận"></textarea>
										<button onclick="postCmt()" class="form__btn">Gửi</button>
									</div>
								</div>
							</div>
							<!-- end comments -->
						</div>
					</div>
				</div>
				<!-- end content tabs -->
			</div>
		</div>
	</div>
</section>



<script>
   let rate;
	const renderRate = (_rate)=>{
		  for (let i=1;i<=5;i++){
                  			 document.getElementById(`star-${i}`).style.color = "#c9c9c9";
                  		 }
		  for (let i=1;i<=_rate;i++){
         			 document.getElementById(`star-${i}`).style.color = "#e19414";
         		 }
	}
	const handleRate= (_rate)=>{
		 rate = _rate;
		 renderRate(rate);
	}
	
	if(GetUserData()!=null){
        const role = GetUserData().role;
		if (role==='Admin'){
			$('#add-chapter').show();
		}
		if (role==='Admin'||role==='UserVip'){
			$('.td-vip').hide();
		}
		// $('#da-follow').show();
        // $('#not-follow').show();
	}
   

	 $(document).ready(function() {
	    renderRate();
		checkFollow();
		loadCmt();

	 })

	 const renderBtnFollow = (check)=>{
		if(check){
			$("#da-follow").hide();
		    $("#not-follow").show();
		}else{
			$("#not-follow").hide();
		    $("#da-follow").show();
		}
	 }
	
	 const follow=()=>{
		if(GetUserData()!=null){
			 var mangaId = $("#mangaId").val();
			 var user = GetUserData();
				 $.ajax({
					url: urlServiceManga + `/Manga/FollowManga?userId=${user.userId}&mangaId=${mangaId}`,
					type:"post",
					success: function (result) {
						checkFollow();
						ShowNotificationSuccess("Đã thêm vào danh sách theo dõi");
	
					}
				});
		}else {
			window.location.href = 'http://localhost:5030/Auth/AuthLogin';
		}
	 }

	 const postCmt = ()=>{
		if(GetUserData()!=null){
			 var mangaId = $("#mangaId").val();
			 var user = GetUserData();
			 var value = $("#value-cmt").val();
			 $("#value-cmt").val("");
			 if(!value){
					ShowNotificationError("Không được để trống");
					 return;
			 }
				 $.ajax({
					url: urlServiceManga + `/Manga/Comment?userId=${user.userId}&mangaId=${mangaId}&value=${value}`,
					type:"post",
					success: function (result) {
					  //== render cmt
					  loadCmt();
					}
				});
		}else {
			window.location.href = 'http://localhost:5030/Auth/AuthLogin';
		}
	 }

	  const loadCmt = ()=>{
	     var mangaId = $("#mangaId").val();
		     $.ajax({
                url: urlServiceManga + `/Manga/Comment?mangaId=${mangaId}`,
                success: function (result) {
					var content="";
				     result.data.forEach((value)=>{
					     content+=`
						    <li class="comments__item">
												<div class="comments__autor">
														<img class="comments__avatar" src="${value.imgUser || '/lib/img/avatar-default.jpg'}" alt="">
													<span class="comments__name">${value.nameUser}</span>
													<span class="comments__time">${value.date}</span>
												</div>
												<p class="comments__text">${value.content}</p>
											</li>

						 `
						 $(".comments__list").html(content);
					 })
                }
            });
	 }

	  const unFollow=()=>{
		 var mangaId = $("#mangaId").val();
		 var user = GetUserData();
		     $.ajax({
                url: urlServiceManga + `/Manga/FollowManga?userId=${user.userId}&mangaId=${mangaId}`,
				type:"delete",
                success: function (result) {
					console.log("result un f",result);
					checkFollow();
					ShowNotificationSuccess("Đã xoá khỏi danh sách theo dõi");
                }
            });
	 }

	 const checkFollow=()=>{
		if(GetUserData()!=null){
			 var mangaId = $("#mangaId").val();
			 var user = GetUserData();
				 $.ajax({
					url: urlServiceManga + `/Manga/CheckFollowManga?userId=${user.userId}&mangaId=${mangaId}`,
					success: function (result) {
						console.log("result",result);
					   renderBtnFollow(!result.data);
					}
				});	
		}
	 }
	 
	 // Delete chapter functionality
	 const deleteChapter = (chapterId, chapterNumber, chapterName, mangaId) => {
		 console.log('=== DELETE CHAPTER REQUEST ===');
		 console.log('Chapter ID:', chapterId);
		 console.log('Chapter Number:', chapterNumber);
		 console.log('Chapter Name:', chapterName);
		 console.log('Manga ID:', mangaId);
		 
		 // Show confirmation dialog
		 if (!confirm(`Bạn có chắc chắn muốn xóa Chapter ${chapterNumber} - "${chapterName}"?\n\nHành động này không thể hoàn tác!`)) {
			 console.log('User cancelled delete operation');
			 return;
		 }
		 
		 // Show loading state
		 const deleteBtn = $(`.btn-delete-chapter[data-chapter-id="${chapterId}"]`);
		 const originalText = deleteBtn.html();
		 deleteBtn.prop('disabled', true).html('🔄 Đang xóa...');
		 
		 // Make delete request
		 $.ajax({
			 url: `/Manager/DeleteChapter?chapterId=${chapterId}&mangaId=${mangaId}`,
			 type: 'DELETE',
			 timeout: 30000,
			 success: function(result) {
				 console.log('✅ Delete chapter response:', result);
				 
				 if (result.success) {
					 // Remove row from table with animation
					 $(`#chapter-row-${chapterId}`).fadeOut(500, function() {
						 $(this).remove();
						 
						 // Check if no chapters left
						 const remainingChapters = $('[id^="chapter-row-"]').length;
						 if (remainingChapters === 0) {
							 $('tbody').append(`
								 <tr>
									 <td colspan="4" style="text-align: center; padding: 20px; color: #666;">
										 Chưa có chapter nào. <a href="/Manager/ViewAddChapter?id=${mangaId}" style="color: #007bff;">Thêm chapter đầu tiên</a>
									 </td>
								 </tr>
							 `);
						 }
					 });
					 
					 // Show success message
					 ShowNotificationSuccess(result.message || `Đã xóa Chapter ${chapterNumber} thành công`);
					 
					 console.log('✅ Chapter deleted successfully from UI');
				 } else {
					 // Show error message
					 console.error('❌ Delete failed:', result.message);
					 ShowNotificationError(result.message || 'Xóa chapter thất bại');
					 
					 // Restore button state
					 deleteBtn.prop('disabled', false).html(originalText);
				 }
			 },
			 error: function(xhr, status, error) {
				 console.error('💥 Delete chapter AJAX error:', { xhr, status, error });
				 console.error('Response text:', xhr.responseText);
				 
				 let errorMessage = 'Lỗi khi xóa chapter';
				 
				 if (xhr.status === 0) {
					 errorMessage = 'Không thể kết nối tới server';
				 } else if (xhr.status === 404) {
					 errorMessage = 'Chapter không tồn tại hoặc đã bị xóa';
				 } else if (xhr.status === 500) {
					 errorMessage = 'Lỗi server khi xóa chapter';
				 } else if (status === 'timeout') {
					 errorMessage = 'Timeout - Server phản hồi quá chậm';
				 } else {
					 // Try to parse error response
					 try {
						 const response = JSON.parse(xhr.responseText);
						 if (response.message) {
							 errorMessage = response.message;
						 }
					 } catch (e) {
						 // Use default error message
					 }
				 }
				 
				 ShowNotificationError(errorMessage);
				 
				 // Restore button state  
				 deleteBtn.prop('disabled', false).html(originalText);
			 }
		 });
	 }
	 
	 // Initialize delete chapter event handlers
	 $(document).ready(function() {
		 // Show admin actions for admin users
		 if (GetUserData() != null) {
			 const role = GetUserData().role;
			 if (role === 'Admin') {
				 $('#admin-actions-header').show();
				 $('.admin-actions-cell').show();
				 $('#add-chapter').show();
			 }
		 }
		 
		 // Bind delete chapter button events
		 $(document).on('click', '.btn-delete-chapter', function() {
			 const chapterId = $(this).data('chapter-id');
			 const chapterNumber = $(this).data('chapter-number');
			 const chapterName = $(this).data('chapter-name');
			 const mangaId = $(this).data('manga-id');
			 
			 deleteChapter(chapterId, chapterNumber, chapterName, mangaId);
		 });
		 
		 // Add hover effect for delete buttons
		 $(document).on('mouseenter', '.btn-delete-chapter', function() {
			 $(this).css('background', '#c82333');
		 }).on('mouseleave', '.btn-delete-chapter', function() {
			 if (!$(this).prop('disabled')) {
				 $(this).css('background', '#dc3545'); 
			 }
		 });
	 });
	
</script>
<script src="~/js/Notification.js"></script>